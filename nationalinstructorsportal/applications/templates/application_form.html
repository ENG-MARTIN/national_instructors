{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DITTE Application Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container1 {
            margin: 20px;

        }
        .card {
            border-radius: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            border-radius: 5px;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        label {
            font-weight: bold;
        }
        input, select {
            border-radius: 5px;
        }
        form {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }
        .nav-tabs .nav-link.active {
            background-color: #28a745;
            color: white;
        }
        .step-indicator {
            margin: 5px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container1">
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <h3>DITTE Application Form</h3>
            </div>
            <div class="card-body">
                <!-- Top Tabs -->
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="application-tab" data-bs-toggle="tab" data-bs-target="#application" type="button" role="tab" aria-controls="application" aria-selected="true">
                            <i class="fas fa-file-alt me-2"></i>Application
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab" aria-controls="status" aria-selected="false">
                            <i class="fas fa-info-circle me-2"></i>Status
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admissions-tab" data-bs-toggle="tab" data-bs-target="#admissions" type="button" role="tab" aria-controls="admissions" aria-selected="false">
                            <i class="fas fa-user-graduate me-2"></i>Admissions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">
                            <i class="fas fa-user-circle me-2"></i>Profile
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="myTabContent">
                    <!-- Application Tab -->
                    <div class="tab-pane fade show active" id="application" role="tabpanel" aria-labelledby="application-tab">
                        <!-- Multi-Step Form -->
                        <form method="post" id="multiStepForm" class="mt-3" action="{% url 'apply_ditte' %}">
                            {% csrf_token %}  
                            <!-- Progress Indicator -->
                            <div class="d-flex justify-content-between mb-4">
                                <button type="button" class="btn btn-outline-primary step-indicator active" data-step="1">1. Personal Info</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="2">2. Education</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="3">3. Employment</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="4">4. Programme</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="5">5. Sponsorship</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="6">6. Declaration</button>
                            </div>
                
                            <!-- Step 1: Personal Information -->
                            <div class="step active" id="step1">
                                <h5 class="text-primary">Personal Information</h5>
                                <div class="mb-3">
                                    <label class="form-label">Surname</label>
                                    <input type="text" class="form-control" name="surname" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Other Names</label>
                                    <input type="text" class="form-control" name="other_names" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Gender</label>
                                    <select class="form-select" name="gender" required>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" name="date_of_birth" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Nationality</label>
                                    <input type="text" class="form-control" name="nationality" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Home District</label>
                                    <input type="text" class="form-control" name="home_district" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">County</label>
                                    <input type="text" class="form-control" name="county" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Sub County</label>
                                    <input type="text" class="form-control" name="sub_county" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Permanent Address</label>
                                    <input type="text" class="form-control" name="permanent_address" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Marital Status</label>
                                    <select class="form-select" name="marital_status" required>
                                        <option value="single">Single</option>
                                        <option value="married">Married</option>
                                        <option value="divorced">Divorced</option>
                                        <option value="widowed">Widowed</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Number of Children</label>
                                    <input type="number" class="form-control" name="children" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Religious Affiliation</label>
                                    <input type="text" class="form-control" name="religion" required>
                                </div>                                
                                
                                <button type="button" class="btn btn-primary next-step" data-next="2">Next</button>
                            </div>                                          
                            
                            <!-- Step 2: Education Background -->
                            <div class="step" id="step2">
                                <h5 class="text-primary">Education Background</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="educationTable">
                                        <thead>
                                            <tr>
                                                <th>School Name</th>
                                                <th>Period</th>
                                                <th>Qualification</th>
                                                <th>Grade</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Rows will be added dynamically here -->
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-success btn-sm mt-2" id="addEducationRow">Add Row</button>
                                <div class="mt-3">
                                    <label class="form-label">Major Subjects</label>
                                    <input type="text" class="form-control" name="major_subjects" required>
                                </div>
                                <button type="button" class="btn btn-secondary prev-step" data-prev="1">Previous</button>
                                <button type="button" class="btn btn-primary next-step" data-next="3">Next</button>
                            </div>


                            <input type="hidden" name="education_backgrounds" id="educationBackgrounds">

                            <!-- Hidden input to store serialized employment data -->
                            <input type="hidden" name="employment_records" id="employmentRecords">
                
                            <!-- Step 3: Employment Record -->
<div class="step" id="step3">
    <h5 class="text-primary">Employment Record (if applicable)</h5>
    <div class="table-responsive">
        <table class="table table-bordered" id="employmentTable">
            <thead>
                <tr>
                    <th>Institution</th>
                    <th>Role</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added dynamically here -->
            </tbody>
        </table>
    </div>
    <button type="button" class="btn btn-success btn-sm mt-2" id="addEmploymentRow">Add Row</button>
    <button type="button" class="btn btn-secondary prev-step" data-prev="2">Previous</button>
    <button type="button" class="btn btn-primary next-step" data-next="4">Next</button>
</div>
                            <!-- Step 4: Programme and Specialisation -->
                            <!-- Step 4: Programme and Specialisation -->
<div class="step" id="step4">
    <h5 class="text-primary">Programme and Specialisation</h5>
    <div class="mb-3">
        <label class="form-label">Programme</label>
        <select class="form-select" name="programme" required>
            <option value="" disabled selected>Select Programme</option>
            <option value="Agricultural Production">Agricultural Production</option>
            <option value="Automobile Engineering">Automobile Engineering</option>
            <option value="Civil and Building Engineering">Civil and Building Engineering</option>
            <option value="Electrical Engineering">Electrical Engineering</option>
            <option value="Leather Tanning & Leather Goods Production">Leather Tanning & Leather Goods Production</option>
            <option value="Metal Fabrication">Metal Fabrication</option>
            <option value="Tailoring and Garments Design">Tailoring and Garments Design</option>
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Programme Status</label>
        <select class="form-select" name="programme_status" required>
            <option value="" disabled selected>Select Programme Status</option>
            <option value="Full Time Government (1 Year)">Full Time Government (1 Year)</option>
            <option value="Full Time Private (1 Year)">Full Time Private (1 Year)</option>
        </select>
    </div>
    <button type="button" class="btn btn-secondary prev-step" data-prev="3">Previous</button>
    <button type="button" class="btn btn-primary next-step" data-next="5">Next</button>
</div>
                
                            <!-- Step 5: Sponsorship -->
                            <div class="step" id="step5">
                                <h5 class="text-primary">Sponsorship</h5>
                                <div class="mb-3">
                                    <label class="form-label">Sponsor Name</label>
                                    <input type="text" class="form-control" name="sponsor_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Sponsor Address</label>
                                    <input type="text" class="form-control" name="sponsor_address" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Sponsor Phone</label>
                                    <input type="tel" class="form-control" name="sponsor_phone" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Sponsor Email</label>
                                    <input type="email" class="form-control" name="sponsor_email" required>
                                </div>
                                <button type="button" class="btn btn-secondary prev-step" data-prev="4">Previous</button>
                                <button type="button" class="btn btn-primary next-step" data-next="6">Next</button>
                            </div>
                
                            <!-- Step 6: Declaration and Endorsement -->
                            <div class="step" id="step6">
                                <h5 class="text-primary">For Admin use only</h5>
                                <br>
                                {% comment %} <div class="mb-3">
                                    <label class="form-label">Signature</label>
                                    <input type="text" class="form-control" name="declaration_signature" required>
                                </div>
                                <h5 class="text-primary">Endorsement</h5>
                                <div class="mb-3">
                                    <label class="form-label">Endorser's Name</label>
                                    <input type="text" class="form-control" name="endorser_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Designation</label>
                                    <input type="text" class="form-control" name="endorser_designation" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Institution/Organization</label>
                                    <input type="text" class="form-control" name="endorser_institution" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" name="endorser_address" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Signature</label>
                                    <input type="text" class="form-control" name="endorser_signature" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Official Stamp</label>
                                    <input type="text" class="form-control" name="official_stamp" required>
                                </div> {% endcomment %}
                                <button type="button" class="btn btn-secondary prev-step" data-prev="5">Previous</button>
                                <button type="submit" class="btn btn-success">Submit Application</button>
                            </div>
                        </form>
                    </div>

                    <!-- Status Tab -->
<div class="tab-pane fade" id="status" role="tabpanel" aria-labelledby="status-tab">
    <div class="card shadow-sm mt-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Application Status</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Application ID:</strong> {{ application.id }}</p>
                    <p><strong>Submission Date:</strong> {{ application.programme }}</p>
                    <p><strong>Estimated Approval Date:</strong> {{ application.estimated_approval_date }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Status:</strong> 
                        <span class="badge 
                            {% if application.status == 'Pending' %} bg-warning 
                            {% elif application.status == 'Approved' %} bg-success 
                            {% elif application.status == 'Rejected' %} bg-danger 
                            {% endif %}">
                            {{ application.status }}
                        </span>
                    </p>
                    <p><strong>Processing Stage:</strong> {{ application.processing_stage }}</p>
                </div>
            </div>
            <hr>
            <h6 class="text-primary">Remarks from Admin</h6>
            <p class="text-muted">{{ application.admin_remarks|default:"No remarks yet." }}</p>
        </div>
    </div>
</div>


                    <!-- Payments Tab -->
                    <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">
                        <div class="mt-3">
                            <h5 class="text-primary">Payment Information</h5>
                            <p>Payment details and history will be displayed here.</p>
                        </div>
                    </div>

                    <!-- Admissions Tab -->
                    <div class="tab-pane fade" id="admissions" role="tabpanel" aria-labelledby="admissions-tab">
                        <div class="mt-3">
                            <h5 class="text-primary">Admissions Information</h5>
                            <p>Admissions-related information will be displayed here.</p>
                        </div>
                    </div>

                     <!-- Profile Tab -->
<div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
    <div class="mt-3">
        <h5 class="text-primary">Profile Information</h5>
        <div class="welcome-message">
            <h1>Welcome, {{ user.surname }} {{ user.other_names }}!</h1>
            <p>You are logged in as <strong id="user-email">{{ user.email }}</strong>.</p>
        </div>

        <!-- Display Applications -->
<div class="mt-4">
    <h5 class="text-primary">Your Applications</h5>
    {% if applications %}
        <!-- In your application_form.html where you display applications -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Application ID</th>
            <th>Programme</th>
            <th>Status</th>
            <th>Submission Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for application in applications %}
            <tr>
                <td>{{ application.id }}</td>
                <td>{{ application.programme }}</td>
                <td>
                    <span class="badge 
                        {% if application.status == 'Pending' %} bg-warning 
                        {% elif application.status == 'Approved' %} bg-success 
                        {% elif application.status == 'Rejected' %} bg-danger 
                        {% endif %}">
                        {{ application.status }}
                    </span>
                </td>
                <td>{{ application.submission_date }}</td>
                <td>
                    <a href="{% url 'view_application_details' application.id %}" 
                       class="btn btn-sm btn-primary">
                        View Details
                    </a>
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>
    {% else %}
        <p>No applications found.</p>
    {% endif %}
</div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript to handle step navigation
        document.addEventListener('DOMContentLoaded', function () {
            const steps = document.querySelectorAll('.step');
            const nextButtons = document.querySelectorAll('.next-step');
            const prevButtons = document.querySelectorAll('.prev-step');
            const stepIndicators = document.querySelectorAll('.step-indicator');

            let currentStep = 1;

            function showStep(stepNumber) {
                steps.forEach((step, index) => {
                    if (index + 1 === stepNumber) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });

                stepIndicators.forEach((indicator, index) => {
                    if (index + 1 === stepNumber) {
                        indicator.classList.remove('btn-outline-primary');
                        indicator.classList.add('btn-primary');
                    } else {
                        indicator.classList.remove('btn-primary');
                        indicator.classList.add('btn-outline-primary');
                    }
                });
            }

            nextButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentStep < steps.length) {
                        currentStep++;
                        showStep(currentStep);
                    }
                });
            });

            prevButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentStep > 1) {
                        currentStep--;
                        showStep(currentStep);
                    }
                });
            });

            stepIndicators.forEach(indicator => {
                indicator.addEventListener('click', () => {
                    const stepNumber = parseInt(indicator.getAttribute('data-step'));
                    currentStep = stepNumber;
                    showStep(currentStep);
                });
            });
        });
    </script>

    {% comment %} for adding rows {% endcomment %}
<script>
    // Function to add a new row to the education table
    document.getElementById('addEducationRow').addEventListener('click', function () {
        const table = document.querySelector('#educationTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="school_name[]" required></td>
            <td><input type="text" class="form-control" name="period[]" required></td>
            <td><input type="text" class="form-control" name="qualification[]" required></td>
            <td><input type="text" class="form-control" name="grade[]" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        `;
        table.appendChild(newRow);
    });

    // Function to add a new row to the employment table
    document.getElementById('addEmploymentRow').addEventListener('click', function () {
        const table = document.querySelector('#employmentTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="institution[]" required></td>
            <td><input type="text" class="form-control" name="role[]" required></td>
            <td><input type="date" class="form-control" name="from[]" required></td>
            <td><input type="date" class="form-control" name="to[]" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        `;
        table.appendChild(newRow);
    });

    // Function to remove a row
    document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('remove-row')) {
            e.target.closest('tr').remove();
        }
    });
</script>

<script>
    // Function to serialize table data
    function serializeTable(tableId) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const data = [];
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const rowData = {
                school_name: inputs[0].value,
                period: inputs[1].value,
                qualification: inputs[2].value,
                grade: inputs[3].value
            };
            data.push(rowData);
        });
        return JSON.stringify(data);
    }

    // Function to serialize employment table data
    function serializeEmploymentTable(tableId) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const data = [];
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const rowData = {
                institution: inputs[0].value,
                role: inputs[1].value,
                from: inputs[2].value,
                to: inputs[3].value
            };
            data.push(rowData);
        });
        return JSON.stringify(data);
    }

    // Serialize education and employment data before form submission
    document.getElementById('multiStepForm').addEventListener('submit', function (e) {
        // Serialize education table
        const educationData = serializeTable('educationTable');
        document.getElementById('educationBackgrounds').value = educationData;

        // Serialize employment table
        const employmentData = serializeEmploymentTable('employmentTable');
        document.getElementById('employmentRecords').value = employmentData;
    });

    // Function to add a new row to the education table
    document.getElementById('addEducationRow').addEventListener('click', function () {
        const table = document.querySelector('#educationTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="school_name[]" required></td>
            <td><input type="text" class="form-control" name="period[]" required></td>
            <td><input type="text" class="form-control" name="qualification[]" required></td>
            <td><input type="text" class="form-control" name="grade[]" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        `;
        table.appendChild(newRow);
    });

    // Function to add a new row to the employment table
    document.getElementById('addEmploymentRow').addEventListener('click', function () {
        const table = document.querySelector('#employmentTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="institution[]" required></td>
            <td><input type="text" class="form-control" name="role[]" required></td>
            <td><input type="date" class="form-control" name="from[]" required></td>
            <td><input type="date" class="form-control" name="to[]" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        `;
        table.appendChild(newRow);
    });

    // Function to remove a row
    document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('remove-row')) {
            e.target.closest('tr').remove();
        }
    });
</script>

{% comment %} ==============================  this is the retrieving the application details {% endcomment %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const userEmail = document.getElementById('user-email').textContent;

        // Fetch applications for the logged-in user
        fetch(`/get-applications/?email=${userEmail}`)
            .then(response => response.json())
            .then(data => {
                const applicationsList = document.getElementById('applications-list');
                if (data.length > 0) {
                    let html = `
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Application ID</th>
                                    <th>Programme</th>
                                    <th>Status</th>
                                    <th>Submission Date</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    data.forEach(app => {
                        html += `
                            <tr>
                                <td>${app.id}</td>
                                <td>${app.programme}</td>
                                <td>
                                    <span class="badge 
                                        ${app.status === 'Pending' ? 'bg-warning' : 
                                          app.status === 'Approved' ? 'bg-success' : 
                                          app.status === 'Rejected' ? 'bg-danger' : ''}">
                                        ${app.status}
                                    </span>
                                </td>
                                <td>${app.submission_date}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table>`;
                    applicationsList.innerHTML = html;
                } else {
                    applicationsList.innerHTML = '<p>No applications found.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching applications:', error);
                document.getElementById('applications-list').innerHTML = '<p>Error loading applications.</p>';
            });
    });
</script>
</body>
</html>
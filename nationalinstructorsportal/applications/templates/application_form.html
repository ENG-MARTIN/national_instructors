{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DITTE Application Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
       
        body {
            background-color: #f8f9fa;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;    
        }
        
        .container {
            margin: 20px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            border-radius: 5px;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        label {
            font-weight: bold;
        }
        input, select {
            border-radius: 5px;
        }
        form {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);

        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }
        .nav-tabs .nav-link.active {
            background-color: #28a745;
            color: white;
        }
        .step-indicator {
            margin: 5px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <h3>DITTE Application Form</h3>
            </div>
            <div class="card-body">
                <!-- Top Tabs -->
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="application-tab" data-bs-toggle="tab" data-bs-target="#application" type="button" role="tab" aria-controls="application" aria-selected="true">
                            <i class="fas fa-file-alt me-2"></i>Application
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab" aria-controls="status" aria-selected="false">
                            <i class="fas fa-info-circle me-2"></i>Status
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admissions-tab" data-bs-toggle="tab" data-bs-target="#admissions" type="button" role="tab" aria-controls="admissions" aria-selected="false">
                            <i class="fas fa-user-graduate me-2"></i>Admissions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">
                            <i class="fas fa-user-circle me-2"></i>Profile
                        </button>
                    </li>
                </ul>

                <!-- Display Bootstrap alerts -->
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="fas {% if message.tags == 'danger' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}

                <!-- Tab Content -->
                <div class="tab-content" id="myTabContent">
                    <!-- Application Tab -->
                    <div class="tab-pane fade show active" id="application" role="tabpanel" aria-labelledby="application-tab">
                        <!-- Multi-Step Form -->
                        <form method="post" id="multiStepForm" class="mt-3" action="{% url 'apply_ditte' %}">
                            {% csrf_token %}  
                            <!-- Progress Indicator -->
                            <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
                                <button type="button" class="btn btn-outline-primary step-indicator active" data-step="1">1. Personal Info</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="2">2. Education</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="3">3. Employment</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="4">4. Programme</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="5">5. Sponsorship</button>
                                <button type="button" class="btn btn-outline-primary step-indicator" data-step="6">6. Declaration</button>
                            </div>
                            
                
                            <!-- Step 1: Personal Information -->
                            <div class="step active" id="step1">
                                <h5 class="text-primary">Personal Information</h5>
                                <div class="mb-3">
                                    <label class="form-label">Surname</label>
                                    <input type="text" class="form-control" name="surname" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Other Names</label>
                                    <input type="text" class="form-control" name="other_names" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Gender</label>
                                    <select class="form-select" name="gender" required>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" name="date_of_birth" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Nationality</label>
                                    <input type="text" class="form-control" name="nationality" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Home District</label>
                                    <input type="text" class="form-control" name="home_district" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">County</label>
                                    <input type="text" class="form-control" name="county" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Sub County</label>
                                    <input type="text" class="form-control" name="sub_county" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Permanent Address</label>
                                    <input type="text" class="form-control" name="permanent_address" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Marital Status</label>
                                    <select class="form-select" name="marital_status" required>
                                        <option value="single">Single</option>
                                        <option value="married">Married</option>
                                        <option value="divorced">Divorced</option>
                                        <option value="widowed">Widowed</option>
                                    </select>
                                </div>
                                {% comment %} <div class="mb-3">
                                    <label class="form-label">Number of Children</label>
                                    <input type="number" class="form-control" name="children" required>
                                </div> {% endcomment %}
                                <div class="mb-3">
                                    <label class="form-label">Religious Affiliation</label>
                                    <input type="text" class="form-control" name="religion" required>
                                </div>                                
                                
                                <button type="button" class="btn btn-primary next-step" data-next="2">Next</button>
                            </div>                                          
                            
                            <!-- Step 2: Education Background -->
                            <div class="step" id="step2">
                                <h5 class="text-primary">Education Background</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="educationTable">
                                        <thead>
                                            <tr>
                                                <th>School Name</th>
                                                <th>Period</th>
                                                <th>Qualification</th>
                                                <th>Grade</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Rows will be added dynamically here -->
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-success btn-sm mt-2" id="addEducationRow">Add Row</button>
                                <div class="mt-3">
                                    <label class="form-label">Major Subjects</label>
                                    <input type="text" class="form-control" name="major_subjects" required>
                                </div>
                                <br>
                                

                                {% comment %} this is the adding of pdfs  {% endcomment %}    
                                <div class="mt-3">
                                    <label class="form-label">Upload Academic Documents (PDF)</label>
                                    <input type="file" class="form-control" id="academicDocument" accept=".pdf" required>
                                    <small class="text-muted">Please upload your academic documents in PDF format</small>
                                    <button type="button" id="uploadDocumentBtn" class="btn btn-primary mt-2">Upload Document</button>
                                    <div id="uploadStatus" class="mt-2"></div>
                                </div>
                                
                                <!-- Hidden field to store document ID -->
                                <input type="hidden" name="academic_document_id" id="academicDocumentId">
                                
                                <button type="button" class="btn btn-secondary prev-step" data-prev="1">Previous</button>
                                <button type="button" class="btn btn-primary next-step" data-next="3">Next</button>
                            <input type="hidden" name="education_backgrounds" id="educationBackgrounds">
                            </div>
                            <!-- Hidden input to store serialized employment data -->
                            <input type="hidden" name="employment_records" id="employmentRecords">  
                            
                            
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const uploadBtn = document.getElementById('uploadDocumentBtn');
                                    const fileInput = document.getElementById('academicDocument');
                                    const uploadStatus = document.getElementById('uploadStatus');
                                    const academicDocumentId = document.getElementById('academicDocumentId');
                                    
                                    uploadBtn.addEventListener('click', function() {
                                        if (fileInput.files.length === 0) {
                                            uploadStatus.innerHTML = '<div class="alert alert-danger">Please select a file first</div>';
                                            return;
                                        }
                                        
                                        // Get CSRF token
                                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        
                                        // Create FormData object
                                        const formData = new FormData();
                                        formData.append('academic_document', fileInput.files[0]);
                                        formData.append('surname', document.querySelector('[name=surname]').value);
                                        formData.append('other_names', document.querySelector('[name=other_names]').value);
                                        formData.append('email', document.querySelector('[name=email]').value);
                                        formData.append('csrfmiddlewaretoken', csrfToken);
                                        
                                        // Show loading state
                                        uploadBtn.disabled = true;
                                        uploadBtn.textContent = 'Uploading...';
                                        uploadStatus.innerHTML = '<div class="alert alert-info">Uploading document, please wait...</div>';
                                        
                                        // Make AJAX request
                                        fetch('/upload-academic-document/', {
                                            method: 'POST',
                                            body: formData,
                                            headers: {
                                                'X-Requested-With': 'XMLHttpRequest'  // Helps Django identify AJAX requests
                                            }
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                uploadStatus.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                                                academicDocumentId.value = data.document_id;  // Store document ID for form submission
                                            } else {
                                                uploadStatus.innerHTML = `<div class="alert alert-danger">${data.error || 'Upload failed'}</div>`;
                                            }
                                        })
                                        .catch(error => {
                                            uploadStatus.innerHTML = '<div class="alert alert-danger">Error uploading document</div>';
                                            console.error('Error:', error);
                                        })
                                        .finally(() => {
                                            uploadBtn.disabled = false;
                                            uploadBtn.textContent = 'Upload Document';
                                        });
                                    });
                                });
                                </script>
                           

                            <!-- Step 3: Employment Record -->
                <div class="step" id="step3">
                    <h5 class="text-primary">Employment Record (if applicable)</h5>
                    <div class="table-responsive">
                    <table class="table table-bordered" id="employmentTable">
                     <thead>
                <tr>
                    <th>Institution</th>
                    <th>Role</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added dynamically here -->
            </tbody>
        </table>
    </div>
    <button type="button" class="btn btn-success btn-sm mt-2" id="addEmploymentRow">Add Row</button>
</br>
    <br>
    <button type="button" class="btn btn-secondary prev-step" data-prev="2">Previous</button>
    <button type="button" class="btn btn-primary next-step" data-next="4">Next</button>
</div>
                            <!-- Step 4: Programme and Specialisation -->
                            <!-- Step 4: Programme and Specialisation -->
<div class="step" id="step4">
    <h5 class="text-primary">Programme and Specialisation</h5>
    <div class="mb-3">
        <label class="form-label">Programme</label>
        <select class="form-select" name="programme" required>
            <option value="" disabled selected>Select Programme</option>
            <option value="Agricultural Production">Agricultural Production</option>
            <option value="Automobile Engineering">Automobile Engineering</option>
            <option value="Civil and Building Engineering">Civil and Building Engineering</option>
            <option value="Electrical Engineering">Electrical Engineering</option>
            <option value="Leather Tanning & Leather Goods Production">Leather Tanning & Leather Goods Production</option>
            <option value="Metal Fabrication">Metal Fabrication</option>
            <option value="Tailoring and Garments Design">Tailoring and Garments Design</option>
            <option value="Electronics Engineering">Electronics Engineering</option>

        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Programme Status</label>
        <select class="form-select" name="programme_status" required>
            <option value="" disabled selected>Select Programme Status</option>
            <option value="Full Time Government (1 Year)">Full Time Government (1 Year)</option>
            <option value="Full Time Private (1 Year)">Full Time Private (1 Year)</option>
        </select>
    </div>
    <button type="button" class="btn btn-secondary prev-step" data-prev="3">Previous</button>
    <button type="button" class="btn btn-primary next-step" data-next="5">Next</button>
</div>
                
                            <!-- Step 5: Sponsorship -->
                            <div class="step" id="step5">
                                <h5 class="text-primary">Sponsorship</h5>
                                <div class="mb-3">
                                    <label class="form-label">Sponsor Name</label>
                                    <input type="text" class="form-control" name="sponsor_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Sponsor Address</label>
                                    <input type="text" class="form-control" name="sponsor_address" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Sponsor Phone</label>
                                    <input type="tel" class="form-control" name="sponsor_phone" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Sponsor Email</label>
                                    <input type="email" class="form-control" name="sponsor_email" required>
                                </div>
                                <button type="button" class="btn btn-secondary prev-step" data-prev="4">Previous</button>
                                <button type="button" class="btn btn-primary next-step" data-next="6">Next</button>
                            </div>
                
                            <!-- Step 6: Declaration and Endorsement -->
                            <div class="step" id="step6">
                                <div class="container mt-5">
                                    <div class="row">
                                        <div class="col-md-6 offset-md-3">
                                            <div class="card">
                                                <div class="card-header bg-primary text-white">
                                                    <h4>Upload Payment Receipt</h4>
                                                </div>
                                                <div class="card-body">
                                                    <form method="post" enctype="multipart/form-data">
                                                        {% csrf_token %}
                                                        
                                                        <div class="mb-3">
                                                            <label class="form-label">Surname</label>
                                                            {{ form.surname }}
                                                        </div>
                                
                                                        <div class="mb-3">
                                                            <label class="form-label">Other Names</label>
                                                            {{ form.other_names }}
                                                        </div>
                                
                                                        <div class="mb-3">
                                                            <label class="form-label">Email</label>
                                                            {{ form.email }}
                                                        </div>
                                
                                                        <div class="mb-3">
                                                            <label class="form-label">Payment Receipt</label>
                                                            {{ form.receipt }}
                                                        </div>
                                
                                                        <button type="submit" class="btn btn-primary">Submit</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <br>
                                
                                <button type="button" class="btn btn-secondary prev-step" data-prev="5">Previous</button>
                                <button type="submit" class="btn btn-success">Submit Application</button>
                            </div>
                        </form>
                    </div>

                    <!-- Status Tab -->
<div class="tab-pane fade" id="status" role="tabpanel" aria-labelledby="status-tab">
    <div class="card shadow-sm mt-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Application Status</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Application ID:</strong> {{ application.id }}</p>
                    <p><strong>Submission Date:</strong> {{ application.programme }}</p>
                    <p><strong>Estimated Approval Date:</strong> {{ application.estimated_approval_date }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Status:</strong> 
                        <span class="badge 
                            {% if application.status == 'Pending' %} bg-warning 
                            {% elif application.status == 'Approved' %} bg-success 
                            {% elif application.status == 'Rejected' %} bg-danger 
                            {% endif %}">
                            {{ application.status }}
                        </span>
                    </p>
                    <p><strong>Processing Stage:</strong> {{ application.processing_stage }}</p>
                </div>
            </div>
            <hr>
            <h6 class="text-primary">Remarks from Admin</h6>
            <p class="text-muted">{{ application.admin_remarks|default:"No remarks yet." }}</p>
        </div>
    </div>
</div>


                    <!-- Payments Tab -->
                    <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">
                        <div class="mt-3">
                            <h5 class="text-primary">Payment Information</h5>
                            <p>Payment details and history will be displayed here.</p>
                        </div>
                    </div>                    

                     <!-- Profile Tab -->
                     <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        <div class="mt-3">
                            <!-- Header Section with Logout Button -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="text-primary">Profile Information</h5>
                                <a href="{% url 'login' %}" class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </a>
                            </div>
                    
                            <!-- Welcome Card -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-body">
                                    <div class="welcome-message">
                                        <h3 class="card-title">Welcome, {{ user.surname }} {{ user.other_names }}!</h3>
                                        <p class="card-text text-muted">
                                            <i class="bi bi-envelope"></i> Logged in as <strong id="user-email">{{ user.email }}</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                    
                            <!-- Applications Section -->
                            <div class="mt-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-primary">Your Applications</h5>
                                    <span class="badge bg-secondary">{{ applications|length }} application(s)</span>
                                </div>
                    
                                {% if applications %}
                                    <div class="table-responsive">
                                        <table class="table table-hover table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Application ID</th>
                                                    <th>Programme</th>
                                                    <th>Status</th>
                                                    <th>Submission Date</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for application in applications %}
                                                    <tr>
                                                        <td class="fw-bold">#{{ application.id }}</td>
                                                        <td>{{ application.programme }}</td>
                                                        <td>
                                                            <span class="badge 
                                                                {% if application.status == 'Pending' %} bg-warning text-dark
                                                                {% elif application.status == 'Approved' %} bg-success
                                                                {% elif application.status == 'Rejected' %} bg-danger
                                                                {% endif %}">
                                                                {{ application.status }}
                                                            </span>
                                                        </td>
                                                        <td>{{ application.submission_date|date:"M d, Y" }}</td>
                                                        <td>
                                                            <a href="{% url 'view_application_details' application.id %}" 
                                                               class="btn btn-sm btn-outline-primary">
                                                                <i class="bi bi-eye"></i> View
                                                            </a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info" role="alert">
                                        <i class="bi bi-info-circle"></i> No applications found. Would you like to <a href="{% url "apply_ditte" %}" class="alert-link">start a new application</a>?
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript to handle step navigation
        document.addEventListener('DOMContentLoaded', function () {
            const steps = document.querySelectorAll('.step');
            const nextButtons = document.querySelectorAll('.next-step');
            const prevButtons = document.querySelectorAll('.prev-step');
            const stepIndicators = document.querySelectorAll('.step-indicator');

            let currentStep = 1;

            function showStep(stepNumber) {
                steps.forEach((step, index) => {
                    if (index + 1 === stepNumber) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });

                stepIndicators.forEach((indicator, index) => {
                    if (index + 1 === stepNumber) {
                        indicator.classList.remove('btn-outline-primary');
                        indicator.classList.add('btn-primary');
                    } else {
                        indicator.classList.remove('btn-primary');
                        indicator.classList.add('btn-outline-primary');
                    }
                });
            }

            nextButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentStep < steps.length) {
                        currentStep++;
                        showStep(currentStep);
                    }
                });
            });

            prevButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentStep > 1) {
                        currentStep--;
                        showStep(currentStep);
                    }
                });
            });

            stepIndicators.forEach(indicator => {
                indicator.addEventListener('click', () => {
                    const stepNumber = parseInt(indicator.getAttribute('data-step'));
                    currentStep = stepNumber;
                    showStep(currentStep);
                });
            });
        });
    </script>
 
 
 {% comment %} for adding rows {% endcomment %}
<script>
    // Function to add a new row to the education table
    document.getElementById('addEducationRow').addEventListener('click', function () {
        const table = document.querySelector('#educationTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="school_name[]" required></td>
            <td><input type="text" class="form-control" name="period[]" required></td>
            <td><input type="text" class="form-control" name="qualification[]" required></td>
            <td><input type="text" class="form-control" name="grade[]" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        `;
        table.appendChild(newRow);
    });

    // Function to add a new row to the employment table
    document.getElementById('addEmploymentRow').addEventListener('click', function () {
        const table = document.querySelector('#employmentTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="institution[]" required></td>
            <td><input type="text" class="form-control" name="role[]" required></td>
            <td><input type="date" class="form-control" name="from[]" required></td>
            <td><input type="date" class="form-control" name="to[]" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        `;
        table.appendChild(newRow);
    });

    // Function to remove a row
    document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('remove-row')) {
            e.target.closest('tr').remove();
        }
    });
</script>


<script>
    // Function to serialize table data
    function serializeTable(tableId) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const data = [];
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const rowData = {
                school_name: inputs[0].value,
                period: inputs[1].value,
                qualification: inputs[2].value,
                grade: inputs[3].value
            };
            data.push(rowData);
        });
        return JSON.stringify(data);
    }

    // Function to serialize employment table data
    function serializeEmploymentTable(tableId) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const data = [];
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const rowData = {
                institution: inputs[0].value,
                role: inputs[1].value,
                from: inputs[2].value,
                to: inputs[3].value
            };
            data.push(rowData);
        });
        return JSON.stringify(data);
    }

    // Serialize education and employment data before form submission
    document.getElementById('multiStepForm').addEventListener('submit', function (e) {
        // Serialize education table
        const educationData = serializeTable('educationTable');
        document.getElementById('educationBackgrounds').value = educationData;

        // Serialize employment table
        const employmentData = serializeEmploymentTable('employmentTable');
        document.getElementById('employmentRecords').value = employmentData;
    });

    // Function to add a new row to the education table
    document.getElementById('addEducationRow').addEventListener('click', function () {
        const table = document.querySelector('#educationTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="school_name[]" required></td>
            <td><input type="text" class="form-control" name="period[]" required></td>
            <td><input type="text" class="form-control" name="qualification[]" required></td>
            <td><input type="text" class="form-control" name="grade[]" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        `;
        table.appendChild(newRow);
    });

    // Function to add a new row to the employment table
    document.getElementById('addEmploymentRow').addEventListener('click', function () {
        const table = document.querySelector('#employmentTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="institution[]" required></td>
            <td><input type="text" class="form-control" name="role[]" required></td>
            <td><input type="date" class="form-control" name="from[]" required></td>
            <td><input type="date" class="form-control" name="to[]" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        `;
        table.appendChild(newRow);
    });

    // Function to remove a row
    document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('remove-row')) {
            e.target.closest('tr').remove();
        }
    });
</script>

{% comment %} ==============================  this is the retrieving the application details {% endcomment %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const userEmail = document.getElementById('user-email').textContent;

        // Fetch applications for the logged-in user
        fetch(`/get-applications/?email=${userEmail}`)
            .then(response => response.json())
            .then(data => {
                const applicationsList = document.getElementById('applications-list');
                if (data.length > 0) {
                    let html = `
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Application ID</th>
                                    <th>Programme</th>
                                    <th>Status</th>
                                    <th>Submission Date</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    data.forEach(app => {
                        html += `
                            <tr>
                                <td>${app.id}</td>
                                <td>${app.programme}</td>
                                <td>
                                    <span class="badge 
                                        ${app.status === 'Pending' ? 'bg-warning' : 
                                          app.status === 'Approved' ? 'bg-success' : 
                                          app.status === 'Rejected' ? 'bg-danger' : ''}">
                                        ${app.status}
                                    </span>
                                </td>
                                <td>${app.submission_date}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table>`;
                    applicationsList.innerHTML = html;
                } else {
                    applicationsList.innerHTML = '<p>No applications found.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching applications:', error);
                document.getElementById('applications-list').innerHTML = '<p>Error loading applications.</p>';
            });
    });
</script>

</body>
</html>